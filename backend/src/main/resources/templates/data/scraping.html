<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: layout(~{::title}, ~{::content})}">
<head>
    <title>Scraping Management</title>
    <style>
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.running {
            background-color: #28a745;
        }
        
        .status-indicator.idle {
            background-color: #6c757d;
        }
        
        .status-indicator.error {
            background-color: #dc3545;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .log-entry {
            padding: 8px 12px;
            margin-bottom: 4px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            border-left: 3px solid;
        }
        
        .log-entry.info {
            background-color: #e7f3ff;
            border-color: #0066cc;
        }
        
        .log-entry.success {
            background-color: #d4edda;
            border-color: #28a745;
        }
        
        .log-entry.warning {
            background-color: #fff3cd;
            border-color: #ffc107;
        }
        
        .log-entry.error {
            background-color: #f8d7da;
            border-color: #dc3545;
        }
        
        .stat-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .mode-card {
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .mode-card:hover {
            border-color: #0d6efd;
            box-shadow: 0 4px 12px rgba(13, 110, 253, 0.2);
        }
        
        .mode-card.active {
            border-color: #0d6efd;
            background-color: #f0f7ff;
        }
        
        .progress-ring {
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }
        
        .progress-ring-circle {
            stroke-width: 8;
            fill: transparent;
            stroke: #e9ecef;
        }
        
        .progress-ring-value {
            stroke-width: 8;
            fill: transparent;
            stroke: #0d6efd;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.3s;
        }
        
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #0d6efd;
            border: 2px solid #fff;
            box-shadow: 0 0 0 2px #0d6efd;
        }
    </style>
</head>
<body>
    <div th:fragment="content">
        <div class="container-fluid py-4">
            <!-- Modern Header with Status -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2 mb-1">
                        <i class="fas fa-spider me-2 text-primary"></i>Scraping Management
                    </h1>
                    <div class="d-flex align-items-center">
                        <span class="status-indicator" id="statusIndicator"></span>
                        <span id="statusText" class="text-muted">Initialisiere...</span>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button id="quickDiscoverBtn" class="btn btn-lg btn-primary" onclick="quickDiscover()">
                        <i class="fas fa-magic me-2"></i>Schnelles Scraping
                    </button>
                    <button class="btn btn-lg btn-outline-secondary" onclick="refreshAll()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card stat-card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="rounded-circle bg-primary bg-opacity-10 p-3">
                                        <i class="fas fa-calendar-alt fa-2x text-primary"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="text-muted small">Semester</div>
                                    <h3 class="mb-0" id="statSemesters" th:text="${totalSemesters ?: '0'}">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card stat-card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="rounded-circle bg-success bg-opacity-10 p-3">
                                        <i class="fas fa-check-circle fa-2x text-success"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="text-muted small">Erfolgreiche Läufe</div>
                                    <h3 class="mb-0" id="statSuccess" th:text="${successfulRuns ?: '0'}">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card stat-card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="rounded-circle bg-warning bg-opacity-10 p-3">
                                        <i class="fas fa-database fa-2x text-warning"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="text-muted small">Einträge</div>
                                    <h3 class="mb-0" id="statEntries" th:text="${totalEntries ?: '0'}">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card stat-card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="rounded-circle bg-info bg-opacity-10 p-3">
                                        <i class="fas fa-clock fa-2x text-info"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="text-muted small">Letzter Lauf</div>
                                    <div class="fw-bold" id="statLastRun">
                                        <span th:if="${lastRun}" th:text="${#temporals.format(lastRun.startTime, 'dd.MM. HH:mm')}">--</span>
                                        <span th:unless="${lastRun}" class="text-muted">Nie</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="row g-4">
                <!-- Left Column: Scraping Modes -->
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white border-0 py-3">
                            <h5 class="mb-0">
                                <i class="fas fa-sliders-h me-2 text-primary"></i>Scraping-Modus
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-bolt me-1 text-warning"></i>Parallelisierung
                                </label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="parallelEnabled" onchange="updateConfigDebounced()">
                                    <label class="form-check-label" for="parallelEnabled">Parallel aktivieren</label>
                                </div>
                                <div id="parallelConfigFields" class="row g-2 mt-2" style="display:none;">
                                    <div class="col-6">
                                        <label class="form-label small mb-0">Worker</label>
                                        <input type="number" min="1" max="32" class="form-control" id="parallelMaxWorkers" onchange="updateConfigDebounced()">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small mb-0">Sessions</label>
                                        <input type="number" min="1" max="32" class="form-control" id="parallelSessionPoolSize" onchange="updateConfigDebounced()">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label small mb-0">Delay (ms)</label>
                                        <input type="number" min="0" class="form-control" id="parallelInterTaskDelay" onchange="updateConfigDebounced()">
                                    </div>
                                </div>
                                <small class="text-muted d-block mt-1" id="parallelStatusHint"></small>
                                <hr>
                            </div>
                            <div class="mode-card card mb-3 active" id="modeDiscovery" onclick="selectMode('discovery')">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <input type="radio" name="scrapingMode" value="discovery" checked class="form-check-input me-3">
                                        <div>
                                            <h6 class="mb-1">
                                                <i class="fas fa-magic text-primary me-2"></i>Alle Semester
                                            </h6>
                                            <small class="text-muted">Automatisch alle verfügbaren Semester scrapen</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mode-card card mb-3" id="modeSelection" onclick="selectMode('selection')">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <input type="radio" name="scrapingMode" value="selection" class="form-check-input me-3">
                                        <div>
                                            <h6 class="mb-1">
                                                <i class="fas fa-list-check text-success me-2"></i>Ausgewählte Semester
                                            </h6>
                                            <small class="text-muted">Bestimmte Semester auswählen und scrapen</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Semester Selection Panel -->
                            <div id="semesterSelectionPanel" class="d-none">
                                <label class="form-label fw-bold mt-3">
                                    <i class="fas fa-calendar-alt me-1"></i>Verfügbare Semester
                                </label>
                                <select id="semesterSelect" class="form-select" multiple size="6">
                                    <option disabled>Lade verfügbare Semester...</option>
                                </select>
                                <small class="text-muted d-block mt-2">
                                    <i class="fas fa-info-circle me-1"></i>Mehrfachauswahl mit <kbd>Strg</kbd>/<kbd>⌘</kbd>
                                </small>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="selectAllSemesters()">
                                        <i class="fas fa-check-double me-1"></i>Alle auswählen
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="deselectAllSemesters()">
                                        <i class="fas fa-times me-1"></i>Alle abwählen
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button id="startBtn" class="btn btn-success btn-lg" onclick="startScraping()">
                                    <i class="fas fa-play me-2"></i>Scraping starten
                                </button>
                                <button id="cancelBtn" class="btn btn-danger" onclick="cancelScraping()" disabled>
                                    <i class="fas fa-stop me-2"></i>Abbrechen
                                </button>
                            </div>
                            
                            <hr class="my-3">
                            
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                                <label class="form-check-label" for="autoRefresh">
                                    Auto-Aktualisierung
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column: Progress & Logs -->
                <div class="col-lg-8">
                    <!-- Progress Card -->
                    <div class="card border-0 shadow-sm mb-4" id="progressCard">
                        <div class="card-header bg-white border-0 py-3">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-line me-2 text-primary"></i>Fortschritt
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-12">
                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label text-muted small mb-0">Gesamtfortschritt</label>
                                            <span class="small text-muted" id="overallPercent">0%</span>
                                        </div>
                                        <div class="progress mb-3" style="height:14px;">
                                            <div id="overallProgressBar" class="progress-bar bg-primary" role="progressbar" style="width:0%;"></div>
                                        </div>
                                        <label class="form-label text-muted small">Aktuelle Aufgabe</label>
                                        <div id="currentTask" class="h5 mb-2">Bereit zum Scrapen</div>
                                        <div class="table-responsive" style="max-height:260px; overflow-y:auto;">
                                            <table class="table table-sm align-middle mb-0" id="subTasksTable">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th style="width:28%;">Semester</th>
                                                        <th style="width:14%;" class="text-end">Fortschritt</th>
                                                        <th style="width:34%;">Balken</th>
                                                        <th style="width:24%;">Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="subTasksBody">
                                                    <tr id="noSubtasksRow"><td colspan="4" class="text-muted small">Noch keine Teilaufgaben – starte einen Lauf.</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <div class="row g-3">
                                        <div class="col-6">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-tasks text-primary me-2"></i>
                                                <div>
                                                    <div class="small text-muted">Verarbeitet</div>
                                                    <div class="fw-bold">
                                                        <span id="processedCount">0</span> / <span id="totalCount">0</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-plus-circle text-success me-2"></i>
                                                <div>
                                                    <div class="small text-muted">Neu erstellt</div>
                                                    <div class="fw-bold" id="newEntries">0</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-edit text-warning me-2"></i>
                                                <div>
                                                    <div class="small text-muted">Aktualisiert</div>
                                                    <div class="fw-bold" id="updatedEntries">0</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-clock text-info me-2"></i>
                                                <div>
                                                    <div class="small text-muted">Dauer</div>
                                                    <div class="fw-bold" id="elapsed">00:00</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Logs Card -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-terminal me-2 text-primary"></i>Live-Logs
                            </h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()">
                                <i class="fas fa-trash-alt me-1"></i>Löschen
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div id="logContainer" class="p-3" style="max-height: 400px; overflow-y: auto; background: #f8f9fa;">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                                    <p class="mb-0">Keine Logs verfügbar</p>
                                    <small>Starte ein Scraping, um Logs zu sehen</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
        // ---- Parallel Config Handling ----
        let configUpdateTimer = null;
        async function loadConfig() {
            try {
                const resp = await fetch('/api/scraping/config');
                if (!resp.ok) return;
                const cfg = await resp.json();
                document.getElementById('parallelEnabled').checked = cfg.parallelEnabled;
                document.getElementById('parallelMaxWorkers').value = cfg.parallelMaxWorkers;
                document.getElementById('parallelSessionPoolSize').value = cfg.parallelSessionPoolSize;
                document.getElementById('parallelInterTaskDelay').value = cfg.parallelInterTaskDelay;
                reflectParallelState();
            } catch(e) { console.warn('Config load failed', e); }
        }
        function reflectParallelState() {
            const enabled = document.getElementById('parallelEnabled').checked;
            document.getElementById('parallelConfigFields').style.display = enabled ? 'flex' : 'none';
            document.getElementById('parallelStatusHint').textContent = enabled ? 'Parallelmodus aktiv – Programme werden gleichzeitig verarbeitet.' : 'Sequentieller Modus – ein Studiengang nach dem anderen.';
        }
        async function updateConfig() {
            const payload = {
                parallelEnabled: document.getElementById('parallelEnabled').checked,
                parallelMaxWorkers: parseInt(document.getElementById('parallelMaxWorkers').value || '1'),
                parallelSessionPoolSize: parseInt(document.getElementById('parallelSessionPoolSize').value || '1'),
                parallelInterTaskDelay: parseInt(document.getElementById('parallelInterTaskDelay').value || '0')
            };
            try {
                const resp = await fetch('/api/scraping/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!resp.ok) {
                    addLog('error', 'Konfig konnte nicht gespeichert werden');
                } else {
                    const saved = await resp.json();
                    addLog('info', 'Konfiguration aktualisiert: Parallel=' + saved.parallelEnabled + ', Worker=' + saved.parallelMaxWorkers);
                }
                reflectParallelState();
            } catch(e) { addLog('error', 'Fehler beim Speichern der Konfiguration'); }
        }
        function updateConfigDebounced() {
            reflectParallelState();
            if (configUpdateTimer) clearTimeout(configUpdateTimer);
            configUpdateTimer = setTimeout(updateConfig, 400);
        }
        // ---- Ende Parallel Config ----
        let refreshInterval = null;
        let startTime = null;
        let elapsedTimer = null;
        let latestLogTimestamp = null;
        
        // Mode Selection
        function selectMode(mode) {
            document.querySelectorAll('.mode-card').forEach(card => card.classList.remove('active'));
            const modeId = 'mode' + mode.charAt(0).toUpperCase() + mode.slice(1);
            document.getElementById(modeId).classList.add('active');
            document.querySelector(`input[value="${mode}"]`).checked = true;
            
            // Show/hide selection panel
            document.getElementById('semesterSelectionPanel').classList.toggle('d-none', mode !== 'selection');
        }
        
        // Quick Discovery
        function quickDiscover() {
            selectMode('discovery');
            setTimeout(() => startScraping(), 100);
        }
        
        // Semester selection helpers
        function selectAllSemesters() {
            const select = document.getElementById('semesterSelect');
            for (let i = 0; i < select.options.length; i++) {
                if (!select.options[i].disabled) {
                    select.options[i].selected = true;
                }
            }
        }
        
        function deselectAllSemesters() {
            const select = document.getElementById('semesterSelect');
            for (let i = 0; i < select.options.length; i++) {
                select.options[i].selected = false;
            }
        }
        
        // Start Scraping
        async function startScraping() {
            const mode = document.querySelector('input[name="scrapingMode"]:checked').value;
            let endpoint, body = null;
            
            try {
                switch(mode) {
                    case 'discovery':
                        endpoint = '/api/scraping/discover-and-scrape';
                        break;
                    case 'selection':
                        const selected = Array.from(document.getElementById('semesterSelect').selectedOptions)
                            .map(opt => opt.value);
                        if (selected.length === 0) {
                            showNotification('Bitte wähle mindestens ein Semester aus', 'warning');
                            return;
                        }
                        endpoint = '/api/scraping/scrape-semesters';
                        body = JSON.stringify({ semesterIdentifiers: selected });
                        break;
                }
                
                updateUI('running');
                startElapsedTimer();
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: body ? { 'Content-Type': 'application/json' } : {},
                    body: body
                });
                
                const data = await response.json();
                
                if (data.success === false) {
                    throw new Error(data.message || 'Scraping fehlgeschlagen');
                }
                
                addLog('info', 'Scraping erfolgreich gestartet');
                startAutoRefresh();
                
            } catch (error) {
                console.error('Error:', error);
                addLog('error', 'Fehler: ' + error.message);
                showNotification('Fehler beim Starten: ' + error.message, 'error');
                updateUI('idle');
            }
        }
        
        // Cancel Scraping
        async function cancelScraping() {
            try {
                const response = await fetch('/api/scraping/cancel', { method: 'POST' });
                let data = {};

                try {
                    data = await response.json();
                } catch (_) {
                    // ignore JSON parse errors and fall back to defaults
                }

                if (!response.ok || data.success === false) {
                    const message = data.message || 'Abbrechen fehlgeschlagen';
                    throw new Error(message);
                }

                const message = data.message || 'Scraping wurde abgebrochen';
                addLog('warning', message);
                showNotification(message, 'warning');
                stopElapsedTimer();
                stopAutoRefresh();
                updateUI('idle');
                await refreshStatus();
            } catch (error) {
                console.error('Error:', error);
                addLog('error', 'Fehler beim Abbrechen: ' + error.message);
                showNotification('Fehler beim Abbrechen: ' + error.message, 'error');
            }
        }
        
        // Refresh Status
        async function refreshStatus() {
            try {
                const response = await fetch('/api/scraping/status');
                const data = await response.json();

                const status = (data.status || 'idle').toLowerCase();
                updateStatusIndicator(status);
                updateUI(status === 'running' ? 'running' : 'idle');
                updateProgress(data);

                if (data.logs && data.logs.length > 0) {
                    const recentLogs = data.logs.slice(-10);
                    const newLogs = recentLogs.filter(log => {
                        if (!log.timestamp) {
                            return latestLogTimestamp === null;
                        }
                        const logTime = new Date(log.timestamp).getTime();
                        return Number.isNaN(logTime) || latestLogTimestamp === null || logTime > latestLogTimestamp;
                    });

                    newLogs.forEach(log => {
                        addLog(log.level.toLowerCase(), log.message, false, log.timestamp);

                        let logTime = log.timestamp ? new Date(log.timestamp).getTime() : Date.now();
                        if (Number.isNaN(logTime)) {
                            logTime = Date.now();
                        }
                        if (!Number.isNaN(logTime)) {
                            latestLogTimestamp = latestLogTimestamp === null
                                ? logTime
                                : Math.max(latestLogTimestamp, logTime);
                        }
                    });
                }

                if (status !== 'running') {
                    stopElapsedTimer();
                    stopAutoRefresh();
                }
                
            } catch (error) {
                console.error('Error refreshing status:', error);
            }
        }
        
        function renderSubTasks(subTasks){
            const body = document.getElementById('subTasksBody');
            if(!body) return;
            body.innerHTML='';
            if(!subTasks || subTasks.length===0){
                body.innerHTML='<tr id="noSubtasksRow"><td colspan="4" class="text-muted small">Noch keine Teilaufgaben – starte einen Lauf.</td></tr>';
                return;
            }
            subTasks.forEach(st=>{
                const percent = st.progress || 0;
                const status = (st.status||'idle');
                const badge = {
                    completed:'<span class="badge bg-success">fertig</span>',
                    failed:'<span class="badge bg-danger">fehler</span>',
                    running:'<span class="badge bg-primary">läuft</span>',
                    paused:'<span class="badge bg-warning text-dark">pausiert</span>',
                    idle:'<span class="badge bg-secondary">idle</span>'
                }[status] || '<span class="badge bg-secondary">'+status+'</span>';
                const barClass = percent===100 ? 'bg-success' : 'bg-info';
                const msg = st.message ? '<div class="small text-muted">'+escapeHtml(st.message)+'</div>' : '';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="fw-semibold text-truncate" title="${escapeHtml(st.label||st.id)}">${escapeHtml(st.label||st.id)}</td>
                    <td class="text-end"><span class="small">${percent}%</span></td>
                    <td>
                        <div class="progress" style="height:10px;">
                            <div class="progress-bar ${barClass}" role="progressbar" style="width:${percent}%;" aria-valuenow="${percent}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </td>
                    <td>${badge}${msg}</td>`;
                body.appendChild(tr);
            });
        }

        function updateProgress(data){
            if(!data) return;
            const overall = data.progress || 0;
            const bar = document.getElementById('overallProgressBar');
            if(bar) bar.style.width = overall + '%';
            const pct = document.getElementById('overallPercent');
            if(pct) pct.textContent = overall + '%';
            document.getElementById('currentTask').textContent = data.message || data.currentTask || 'Bereit';
            document.getElementById('processedCount').textContent = data.processedCount || 0;
            document.getElementById('totalCount').textContent = data.totalCount || 0;
            document.getElementById('newEntries').textContent = data.newEntries || 0;
            document.getElementById('updatedEntries').textContent = data.updatedEntries || 0;
            if(data.subTasks){ renderSubTasks(data.subTasks); }
        }
        
        // Update Status Indicator
        function updateStatusIndicator(status) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            indicator.className = 'status-indicator';
            
            switch(status.toLowerCase()) {
                case 'running':
                    indicator.classList.add('running');
                    text.textContent = 'Läuft';
                    break;
                case 'completed':
                    indicator.classList.add('idle');
                    text.textContent = 'Abgeschlossen';
                    break;
                case 'failed':
                    indicator.classList.add('error');
                    text.textContent = 'Fehlgeschlagen';
                    break;
                default:
                    indicator.classList.add('idle');
                    text.textContent = 'Bereit';
            }
        }
        
        // Update UI State
        function updateUI(state) {
            const startBtn = document.getElementById('startBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            if (state === 'running') {
                startBtn.disabled = true;
                cancelBtn.disabled = false;
            } else {
                startBtn.disabled = false;
                cancelBtn.disabled = true;
            }
        }
        
        // Add Log Entry
        function addLog(level, message, scroll = true, timestamp = null) {
            const container = document.getElementById('logContainer');

            // Remove empty state
            if (container.querySelector('.text-center')) {
                container.innerHTML = '';
            }

            const entry = document.createElement('div');
            entry.className = `log-entry ${level}`;

            const parsedTimestamp = timestamp ? new Date(timestamp) : null;
            const time = parsedTimestamp && !Number.isNaN(parsedTimestamp.getTime())
                ? parsedTimestamp.toLocaleTimeString('de-DE')
                : new Date().toLocaleTimeString('de-DE');
            entry.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <span class="flex-grow-1">${escapeHtml(message)}</span>
                    <small class="text-muted ms-2">${time}</small>
                </div>
            `;
            
            container.appendChild(entry);
            
            // Keep only last 100 entries
            while (container.children.length > 100) {
                container.removeChild(container.firstChild);
            }
            
            if (scroll) {
                container.scrollTop = container.scrollHeight;
            }
        }
        
        // Clear Logs
        function clearLogs() {
            latestLogTimestamp = null;
            document.getElementById('logContainer').innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                    <p class="mb-0">Keine Logs verfügbar</p>
                </div>
            `;
        }
        
        // Elapsed Timer
        function startElapsedTimer() {
            startTime = Date.now();
            elapsedTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('elapsed').textContent = 
                    `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }
        
        function stopElapsedTimer() {
            if (elapsedTimer) {
                clearInterval(elapsedTimer);
                elapsedTimer = null;
            }
        }
        
        // Auto Refresh
        function startAutoRefresh() {
            if (document.getElementById('autoRefresh').checked) {
                refreshInterval = setInterval(refreshStatus, 2000);
            }
        }
        
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
        
        // Load Available Semesters
        async function loadAvailableSemesters() {
            const select = document.getElementById('semesterSelect');
            if (!select) return;
            
            try {
                const response = await fetch('/api/scraping/available-semesters');
                const data = await response.json();
                
                select.innerHTML = '';
                if (!data || data.length === 0) {
                    select.innerHTML = '<option disabled>Keine Semester gefunden</option>';
                    return;
                }
                
                data.forEach(sem => {
                    const option = document.createElement('option');
                    option.value = sem.displayName;
                    option.textContent = sem.displayName;
                    if (sem.shortName) {
                        option.textContent += ` (${sem.shortName})`;
                    }
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading semesters:', error);
                select.innerHTML = '<option disabled>Fehler beim Laden</option>';
            }
        }
        
        // Refresh All
        function refreshAll() {
            refreshStatus();
            loadAvailableSemesters();
        }
        
        // Show Notification
        function showNotification(message, type = 'info') {
            // You can integrate a toast library here
            addLog(type, message);
        }
        
        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            refreshStatus();
            loadAvailableSemesters();
            loadConfig();
            
            document.getElementById('autoRefresh').addEventListener('change', function() {
                if (this.checked) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
            stopElapsedTimer();
        });
        </script>
    </div>
</body>
</html>
